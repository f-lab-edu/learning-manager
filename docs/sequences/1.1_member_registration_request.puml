@startuml

title 1.1 [P0] Member Registration - (1) 회원 가입 요청

actor "User (Guest)" as User
participant "MemberRegisterController" as Controller
participant "MemberRegisterService" as AppService
participant "Member" as MemberDomain
participant "Account" as AccountDomain
participant "MemberCommandRepository" as CommandRepo
participant "SignUpConfirmer" as Confirmer
participant "EmailSender" as EmailAdapter

User -> Controller: POST /api/v1/members/register
activate Controller

Controller -> AppService: register(request)
activate AppService

alt Validation Failure
    AppService --> Controller: ErrorResponse (400 Bad Request)
    deactivate AppService
    Controller --> User: Error Code
    deactivate Controller
else Validation Success
    AppService -> MemberDomain: registerDefault()
    activate MemberDomain
    deactivate MemberDomain

    AppService -> MemberDomain: addAccount()
    activate MemberDomain
    MemberDomain -> AccountDomain: create()
    deactivate MemberDomain

    AppService -> CommandRepo: save(newMember)
    activate CommandRepo
    CommandRepo --> AppService: savedMember
    deactivate CommandRepo

    AppService -> Confirmer: generateAndStoreToken()
    activate Confirmer
    Confirmer --> AppService: confirmToken
    deactivate Confirmer

    AppService -> EmailAdapter: sendSignUpConfirmEmail(email, token)
    note right: This call is asynchronous (@Async)
    EmailAdapter --> AppService

    AppService --> Controller: MemberRegistration.Response
    deactivate AppService

    Controller --> User: 201 Created
    deactivate Controller
end

@enduml