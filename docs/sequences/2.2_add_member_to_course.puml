@startuml

title 2.2 [P0] Add Member to Course : 스터디 멤버 추가

actor "User (Manager)" as User
participant "JwtAuthenticationFilter" as Filter
participant "CourseMemberController" as Controller
participant "CourseMemberService" as AppService
participant "CourseQueryRepository" as CourseQueryRepo
participant "MemberQueryRepository" as MemberQueryRepo
participant "Course" as CourseDomain
participant "CourseCommandRepository" as CourseCommandRepo

User -> Controller: POST /api/v1/courses/{courseId}/members
note left: with Authorization header
activate Controller

Controller -> AppService: addSingleMember(courseId, item)
activate AppService

AppService -> CourseQueryRepo: findManagedCourseById(courseId, managerId)
note left: managerId from AuthenticationContextHolder
activate CourseQueryRepo
alt Not a Manager
    CourseQueryRepo --> AppService: Optional.empty()
    deactivate CourseQueryRepo
    AppService --> Controller: AuthorizationException
    deactivate AppService
    Controller --> User: 403 Forbidden
    deactivate Controller
else Is a Manager
    CourseQueryRepo --> AppService: course
    deactivate CourseQueryRepo

    AppService -> MemberQueryRepo: findByEmail(email)
    activate MemberQueryRepo
    alt Member Not Found
        MemberQueryRepo --> AppService: Optional.empty()
        deactivate MemberQueryRepo
        AppService --> Controller: DomainException (MEMBER_NOT_FOUND)
        deactivate AppService
        Controller --> User: 400 Bad Request
        deactivate Controller
    else Member Found
        MemberQueryRepo --> AppService: member
        deactivate MemberQueryRepo

        AppService -> CourseDomain: addMember(memberId, role)
        activate CourseDomain
        deactivate CourseDomain

        AppService -> CourseCommandRepo: save(course)
        activate CourseCommandRepo
        deactivate CourseCommandRepo

        AppService --> Controller: (returns)
        deactivate AppService

        Controller --> User: 200 OK or 207 Multi-Status
        deactivate Controller
    end
end

@enduml
