@startuml

title 1.2 [P0] Member Login (Token Issue)

actor "User (Guest)" as User
participant "AuthController" as Controller
participant "IssueTokenService" as AppService
participant "MemberQueryRepository" as QueryRepo
participant "Member" as MemberDomain
participant "Account" as AccountDomain
participant "PasswordEncoder" as Encoder
participant "JwtProvider" as JwtProvider
participant "RefreshTokenRepository" as RefreshTokenRepo

User -> Controller: POST /api/v1/auth/token
activate Controller

Controller -> AppService: issueToken(request)
activate AppService

AppService -> QueryRepo: findByEmail(email)
activate QueryRepo
alt Member Not Found
    QueryRepo --> AppService: Optional.empty()
    deactivate QueryRepo
    AppService --> Controller: DomainException (INVALID_CREDENTIALS)
    deactivate AppService
    Controller --> User: 400 Bad Request
    deactivate Controller
else Member Found
    QueryRepo --> AppService: member
    deactivate QueryRepo

    AppService -> MemberDomain: findAccountByEmail(email)
    activate MemberDomain
    MemberDomain --> AppService: account
    deactivate MemberDomain

    AppService -> AccountDomain: findCredentialByType(PASSWORD)
    activate AccountDomain
    AccountDomain --> AppService: credential
    deactivate AccountDomain

    AppService -> Encoder: matches(password, credential.secret)
    activate Encoder
    Encoder --> AppService: true/false
    deactivate Encoder

    alt Invalid Password
        AppService --> Controller: DomainException (INVALID_CREDENTIALS)
        deactivate AppService
        Controller --> User: 400 Bad Request
        deactivate Controller
    else Valid Password
        AppService -> JwtProvider: createAccessToken(memberId, email, roles)
        activate JwtProvider
        JwtProvider --> AppService: accessToken
        deactivate JwtProvider

        AppService -> AppService: RefreshToken.create(memberId, ttl)

        AppService -> RefreshTokenRepo: save(refreshToken)
        activate RefreshTokenRepo
        deactivate RefreshTokenRepo

        AppService --> Controller: IssueToken.Response(accessToken, refreshToken, expiresIn)
        deactivate AppService

        Controller --> User: 200 OK
        deactivate Controller
    end
end

@enduml
