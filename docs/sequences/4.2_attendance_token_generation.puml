@startuml

title 4.2 [P1] Attendance Token (QR Code) Generation
note "TODO: Controller/Endpoint 미구현 상태" as N1

actor "User (Manager/Host)" as User
participant "AttendanceTokenController" as Controller
participant "SessionQueryRepository" as SessionQueryRepo
participant "QRCodeGenerator" as QRGenerator

User -> Controller: POST /api/v1/sessions/{sessionId}/attendance-token
activate Controller

note right of Controller
  Permission Check:
  - Is user a Course MANAGER?
  - Or is user a Session HOST?
end note

Controller -> SessionQueryRepo: findById(sessionId)
activate SessionQueryRepo
alt Session Not Found
    SessionQueryRepo --> Controller: Optional.empty()
    deactivate SessionQueryRepo
    Controller --> User: 404 Not Found
    deactivate Controller
else Session Found
    SessionQueryRepo --> Controller: session
    deactivate SessionQueryRepo

    Controller -> QRGenerator: generateQrCode(sessionId)
    activate QRGenerator
    note right of QRGenerator
      Token Format:
      SESSION_{sessionId}_{expiryEpochMilli}
      (5분 유효기간)
    end note
    QRGenerator --> Controller: qrCodeToken
    deactivate QRGenerator

    Controller --> User: 200 OK (token)
    deactivate Controller
end

@enduml
