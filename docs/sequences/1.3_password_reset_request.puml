@startuml

title 1.3 [P1] Password Reset - (1) 패스워드 재설정 요청 (패스워드 분실 시나리오)

actor "User (Guest)" as User
participant "MemberPasswordController" as Controller
participant "PasswordResetService" as AppService
participant "MemberQueryRepository" as QueryRepository
participant "PasswordResetTokenManager" as TokenManager
participant "EmailTaskExecutor" as TaskExecutor
participant "EmailSender" as EmailAdapter

User -> Controller: POST /api/v1/members/reset-password\n{email: "user@example.com"}
activate Controller

Controller -> AppService: requestReset(RequestResetRequest)
activate AppService

AppService -> QueryRepository: findByEmail(Email)
activate QueryRepository
alt Email Not Found
    QueryRepository --> AppService: Optional.empty()
    deactivate QueryRepository
    AppService --> Controller: DomainException\n(PASSWORD_RESET_EMAIL_NOT_FOUND)
    deactivate AppService
    Controller --> User: 400 Bad Request\n{code: "DML030", message: "가입되지 않은 이메일입니다."}
    deactivate Controller
else Email Found
    QueryRepository --> AppService: Optional<Member>
    deactivate QueryRepository

    AppService -> TokenManager: generateAndStoreToken(email, 1시간)
    activate TokenManager
    TokenManager --> AppService: token (UUID 11자리)
    deactivate TokenManager

    AppService -> TaskExecutor: execute(Runnable)\n비동기 이메일 발송
    activate TaskExecutor
    TaskExecutor -> EmailAdapter: sendPasswordResetEmail(email, token)
    activate EmailAdapter
    note right: 재설정 링크:\n/api/v1/members/reset-password?token=xxx
    EmailAdapter --> TaskExecutor: (완료)
    deactivate EmailAdapter
    deactivate TaskExecutor

    AppService --> Controller: RequestResetResponse\n("가입시 사용한 이메일: xxx 로 비밀번호 재설정 메일을 발송했습니다.")
    deactivate AppService

    Controller --> User: 200 OK\n{message: "재설정 메일 발송 완료"}
    deactivate Controller
end
@enduml