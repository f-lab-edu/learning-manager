# CI Pipeline
# 브랜치 푸시 시 빠른 검증 (빌드, 테스트, 보안 스캔)
# 목표: 5분 이내 피드백
name: CI

on:
  push:
    branches:
      - develop
      - main
    # 태그는 release.yml에서 처리
    tags-ignore:
      - '**'

jobs:
  # 1. 빌드 및 테스트
  build:
    name: Build & Test
    uses: ./.github/workflows/_build.yml
    with:
      java-version: '17'
      run-tests: true
      generate-coverage: true
      publish-build-scan: true
    secrets:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # 2. 의존성 그래프 및 보안 스캔
  security-scan:
    name: Security Scan
    needs: [ build ]
    runs-on: ubuntu-latest
    permissions:
      contents: write
      security-events: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: 17
          cache: gradle

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      # GitHub Dependency Graph에 의존성 정보 제출
      # Security > Dependabot alerts에서 취약점 확인 가능
      - name: Submit Dependency Graph
        uses: gradle/actions/dependency-submission@v4
        with:
          build-scan-publish: true
          build-scan-terms-of-use-url: "https://gradle.com/help/legal-terms-of-use"
          build-scan-terms-of-use-agree: "yes"

      # 소스 코드 취약점 스캔 (develop 브랜치에서만)
      - name: Code Vulnerability Scan
        if: github.ref_name == 'develop'
        uses: anchore/scan-action@v3
        id: scan
        with:
          path: "${{ github.workspace }}"
          fail-build: false
          severity-cutoff: high

      - name: Upload Vulnerability Report
        if: github.ref_name == 'develop' && failure()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: ${{ steps.scan.outputs.sarif }}
